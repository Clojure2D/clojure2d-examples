(ns games.the-king.gfx
  (:require [clojure2d.core :as c2d]
            [clojure2d.extra.utils :as u]
            [clojure.java.io :as io]))

(def ^:const point-size 4)
(def ^:const sprite-size (* point-size 8))
(def ^:const canvas-size (* sprite-size 16))

(def pico-8-mono-font (c2d/load-font (io/resource "pico8/pico-8-mono-reversed.ttf")))
(def pico-8-font (c2d/load-font (io/resource "pico8/pico-8.ttf")))

(def pico-8-palette [0x000000 0x1D2B53 0x7E2553 0x008751
                   0xAB5236 0x5F574F 0xC2C3C7 0xFFF1E8
                   0xFF004D 0xFFA300 0xFFEC27 0x00E436
                   0x29ADFF 0x83769C 0xFF77A8 0xFFCCAA])

(def pico-8-sprites ["00000000000000000000000000000000554555555545544555555555555555555555555555555555555555555555555555555555555555650000000000000000"
                   "00000000000000000000a0a0a0a000005c555cc555555454555555b555d555b55555655555556555555675555d55555556566755565555550000000000000000"
                   "00700700000000000000aaaaaaaa0000cccccccc54455d445b555535555553555555555555555555555dd5555555565555566655556675550000000000000000"
                   "00077000000000000008ffffffff8000cc6c6c665d54454555b55555555b535555555555555555555555555555555555555dd675566677553b00b30f00000000"
                   "00077000000000000088f5ffff5f880066ccc6cc4544455555355b555b553355555555555555555555555555555555555555dd655d666655003b00b000000000"
                   "00700700000000000088ffffffff8800dccdcccd4445454555555b5555355355555555555d555555555555555565567555d555555dd666550000000000000000"
                   "0000000000000000088ee887788ee8805dd5ddd55d4454545555b55555355355555555555555556555555d555555d6655555555555ddd55d0000000000000000"
                   "0000000000000000088ee887788ee880555444555555554455553555553555555555555555555555555555555555ddd555555565555555550000000000000000"
                   "0000000000000000028ee888888ee880545555550000000055555555555555555555555555555555555555555555555555555555555555550000000000000000"
                   "0000000000000000028ef888888fe88044555cc500000000555555b55555b555555555555555555555555555555555d555556755555667550000000000000000"
                   "00000000000000000028888888888800455ccccc0000000055555b555b5535555555555555555555555555d5655675555555dd55556667750000000000000000"
                   "00000000000000000028888888888800556c6c6600000000555553555353555555555555565555555555555555d66555555555555d666665003b00bf00000000"
                   "0000000000000000000288888888800055ccc6cc00000000555b55555535555555555d55555555d55675555555ddd555566755565d6666653b00b30000000000"
                   "00000000000000000000228888880000545dcccd0000000055b555555535556555555555555555555dd55555555555555666555555dd66650000000000000000"
                   "000000000000000000000022220000004455ddd5000000005535565555535555555555555555555555555555555555555dd67555d555dd550000000000000000"
                   "00000000000000000000000000000000545555550000000055555555555355555555555555556555555555555556555555dd6555555555560000000000000000"
                   "88008800880088000000a0a0a0a00000555554450088008800880088000000000000000000000000000000000000000000000000000000000000000000000000"
                   "89009900990099000000aaaaaaaa00005c5555540099009900990098000110000001100000011000000110000001100000011000000110000001100000000000"
                   "00000000000000980000ffffffff0000ccccc5558900000000000000001cc100001fc100001ff100001ff100001ff100001ff100001ff100001cf10000000000"
                   "00000000000000980008f5ffff5f8000cc6c6c55890000000000000001ffff1001fffc1001fffc1001ffff1001ffff1001ffff1001cfff1001cfff1000000000"
                   "89000000000000000088ffffffff880066cccc55000000000000009801ffff1001ffff1001fffc1001fffc1001ffff1001cfff1001cfff1001ffff1000000000"
                   "89000000000000000088eee77eee8800dccdd5540000000000000098001ff100001ff100001ff100001fc100001cc100001cf100001ff100001ff10000000000"
                   "0000000000000098088ee887788ee8805dd555448900000000000000000110000001100000011000000110000001100000011000000110000001100000000000"
                   "0000000000000098088ee888888ee880555555458900000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "8900000000000000028ee888888ee880555555450000000000000098000880000008800000088000000880000008800000088000000000000000000000000000"
                   "8900000000000000028ef888888fe880455555550000000000000098000bb000000bb000000bb000000bb000000bb000000bb000000000000000000000000000"
                   "0000000000000098002888888888880055cccc558900000000000000000bb000000bb000000bb000000bb000000bb000000bb000000000000000000000000000"
                   "000000000000009800288888888888005cc6c6c5890000000000000000bbbb0000bbbb0000bbbb0000bbbb0000bbbb0000bbbb00000000000000000000000000"
                   "890000000000000000028888888880005c6cccc5000000000000009800b66b0000bb660000bbb60000bbbb00006bbb000066bb00000000000000000000000000"
                   "890000000000000000002288888800004dccdd55000000000000009800366b00003b6600003bb600003bbb00006bbb000066bb00000000000000000000000000"
                   "0099009900990098000000222200000045dd55548900990099009900003d6b00003bd600003bbd00003bbb00006bbb0000d6bb00000000000000000000000000"
                   "00880088008800880000000000000000555555558800880088008800003333000033330000333300003333000033330000333300000000000000000000000000"
                   "00555555555555555555555555555500000000aa00aa00aa00aa00aa00000000000000aa00aa00aa00aa00aa0000000000ffffffffffff000000000000000000"
                   "05868686868686868686868686868650000000aa00aa00aa00aa00aa00000000000000aa00aa00aa00aa00aa0000000000ffffffffffff000000000000000000"
                   "56666666666666666666666666666685000000aaaaaaaaaaaaaaaaaaaa000000000000aaaaaaaaaaaaaaaaaaaa00000000ffccffffccff000000000000000000"
                   "58666666666666666666666666666665000000aaaaaaaaaaaaaaaaaaaa000000000000aaaaaaaaaaaaaaaaaaaa00000000ffccffffccff000000000000000000"
                   "56666666666666666666666666666685000000ffffffffffffffffffff000000000000ffffffffffffffffffff000000bbffffffffffffbb0000000000000000"
                   "58666666666666666666666666666665000000ffffffffffffffffffff000000000000ffffffffffffffffffff000000bbffffffffffffbb0000000000000000"
                   "566666666666666666666666666666850000eeff55ffffffffffff55ffee00000000eeff66ffffffffffff66ffee0000bb333333333333bb0000000000000000"
                   "586666666666666666666666666666650000eeff55ffffffffffff55ffee00000000eeff66ffffffffffff66ffee0000bb333333333333bb0000000000000000"
                   "5666666666666666666666666666668500eeeeffffffffffffffffffffeeee0000eeeeffffffffffffffffffffeeee00bb333333333333bb0000000000000000"
                   "5866666666666666666666666666666500eeeeffffffffffffffffffffeeee0000eeeeffffffffffffffffffffeeee00bb333333333333bb0000000000000000"
                   "5666666666666666666666666666668500eeee88888888777788888888eeee0000eeee88888888777788888888eeee00ffbbbb3333bbbbff0000000000000000"
                   "5866666666666666666666666666666500eeee88888888777788888888eeee0000eeee88888888777788888888eeee00ffbbbb3333bbbbff0000000000000000"
                   "5666666666666666666666666666668500eeee88888888777788888888eeee0000eeee88888888777788888888eeee0000bbbb0000bbbb000000000000000000"
                   "5866666666666666666666666666666500eeee88888888777788888888eeee0000eeee88888888777788888888eeee0000bbbb0000bbbb000000000000000000"
                   "0568686868686868686868686868685000eeee88888888777788888888eeee0000eeee88888888777788888888eeee0033330000000033330000000000000000"
                   "0055555555555555555555555555550000eeee88888888777788888888eeee0000eeee88888888777788888888eeee0033330000000033330000000000000000"
                   "0000000000000000000000000000000000eeee88888888777788888888eeee0000eeee88888888777788888888eeee0000ffffffffffff000000000000000000"
                   "0000000000000000000000000000000000eeee88888888777788888888eeee0000eeee88888888777788888888eeee0000ffffffffffff000000000000000000"
                   "0000000000000000000000000000000000eeee88888888888888888888eeee0000eeee88888888888888888888eeee0000ff66ffff66ff000000000000000000"
                   "0000000000000000000000000000000000eeee88888888888888888888eeee0000eeee88888888888888888888eeee0000ff66ffff66ff000000000000000000"
                   "0000000000000000000000000000000000ffff88eeee88888888eeee88ffff0000ffff88eeee88888888eeee88ffff00bbffffffffffffbb0000000000000000"
                   "0000000000000000000000000000000000ffff88eeee88888888eeee88ffff0000ffff88eeee88888888eeee88ffff00bbffffffffffffbb0000000000000000"
                   "00000000000000000000000000000000000000eeeeeeee8888eeeeeeee000000000000eeeeeeee8888eeeeeeee000000bb333333333333bb0000000000000000"
                   "00000000000000000000000000000000000000eeeeeeee8888eeeeeeee000000000000eeeeeeee8888eeeeeeee000000bb333333333333bb0000000000000000"
                   "00000000000000000000000000000000000000eeeeeeee0000eeeeeeee000000000000eeeeeeee0000eeeeeeee000000bb333333333333bb0000000000000000"
                   "00000000000000000000000000000000000000eeeeeeee0000eeeeeeee000000000000eeeeeeee0000eeeeeeee000000bb333333333333bb0000000000000000"
                   "00000000000000000000000000000000000000eeeeeeee0000eeeeeeee000000000000eeeeeeee0000eeeeeeee000000ffbbbb3333bbbbff0000000000000000"
                   "00000000000000000000000000000000000000eeeeeeee0000eeeeeeee000000000000eeeeeeee0000eeeeeeee000000ffbbbb3333bbbbff0000000000000000"
                   "0000000000000000000000000000000000000000eeee00000000eeee0000000000000000eeee00000000eeee0000000000bbbb0000bbbb000000000000000000"
                   "0000000000000000000000000000000000000000eeee00000000eeee0000000000000000eeee00000000eeee0000000000bbbb0000bbbb000000000000000000"
                   "00000000000000000000000000000000000000888888000000008888880000000000008888880000000088888800000033330000000033330000000000000000"
                   "00000000000000000000000000000000000000888888000000008888880000000000008888880000000088888800000033330000000033330000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                   "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"])

(defn- get-color
  [x y]
  (-> pico-8-sprites
      (get-in [y x])
      (str)
      (Integer/parseInt 16)
      (pico-8-palette)))

(defn- sprite-image
  ([x y w h]
   (c2d/with-canvas [c (c2d/canvas (* w point-size) (* h point-size) :low)]
     (doseq [posx (range w)
             posy (range h)
             :let [col (get-color (+ x posx) (+ y posy))
                   col (if (zero? col) [0 0 0 0] col)]]
       (c2d/set-color c col)
       (c2d/rect c (* posx point-size) (* posy point-size) point-size point-size))
     (c2d/to-image c))))

(def sprites {:king [(sprite-image 16 0 16 16)
                   (sprite-image 16 16 16 16)]
            :boy [(sprite-image 56 16 8 8)
                  (sprite-image 64 16 8 8)
                  (sprite-image 72 16 8 8)
                  (sprite-image 80 16 8 8)
                  (sprite-image 88 16 8 8)
                  (sprite-image 96 16 8 8)
                  (sprite-image 104 16 8 8)
                  (sprite-image 112 16 8 8)]
            :snake [(sprite-image 112 0 8 8)
                    (sprite-image 112 8 8 8)]
            :target [(sprite-image 0 16 16 16)
                     (sprite-image 40 16 16 16)]
            :bottle [(sprite-image 56 24 8 8)
                     (sprite-image 64 24 8 8)
                     (sprite-image 72 24 8 8)
                     (sprite-image 80 24 8 8)
                     (sprite-image 88 24 8 8)
                     (sprite-image 96 24 8 8)]
            :message-box (sprite-image 0 32 32 16)
            :intro {:king [(sprite-image 32 32 32 32)
                           (sprite-image 64 32 32 32)]
                    :boy [(sprite-image 96 32 16 16)
                          (sprite-image 96 48 16 16)]}
            ;; two sprites per terrain
            :terrain [[(sprite-image 48 0 8 8) ;; grass, level 2
                       (sprite-image 48 8 8 8)]
                      [(sprite-image 56 0 8 8) ;; level 3
                       (sprite-image 56 8 8 8)]
                      [(sprite-image 64 0 8 8) ;; rocks, level 4
                       (sprite-image 64 8 8 8)]
                      [(sprite-image 72 0 8 8) ;; level 5
                       (sprite-image 72 8 8 8)]
                      [(sprite-image 80 0 8 8) ;; level 6
                       (sprite-image 80 8 8 8)]
                      [(sprite-image 88 0 8 8) ;; level 7
                       (sprite-image 88 8 8 8)]
                      [(sprite-image 96 0 8 8) ;; level 8
                       (sprite-image 96 8 8 8)]
                      [(sprite-image 104 0 8 8) ;; level 9
                       (sprite-image 104 8 8 8)]]
            :mud (sprite-image 40 0 8 8)
            ;; four water sprites
            :water {:big (sprite-image 32 0 8 8)
                    :right (sprite-image 32 8 8 8)
                    :left (sprite-image 32 16 8 8)
                    :small (sprite-image 32 24 8 8)}})

(defn sprite
  [& path]
  (get-in sprites path))

;; c2d primitives

(defn draw-sprite
  [canvas sprite x y]
  (c2d/image canvas sprite (* x point-size) (* y point-size)))

(defn draw-text
  [canvas s x y c]
  (c2d/set-color canvas (pico-8-palette c))
  (c2d/text canvas s (* x point-size) (* y point-size)))



(comment
  (u/show-image (get-in sprites [:terrain 3 0])))
